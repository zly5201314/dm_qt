require(["/pc/js/require/config.js?v="+require_ver.version],function(){require(["dataTool","vue","cookie","commonBox","tabs","commonLazy","commonTips","pikaDay","poptips","shopping"],function(e,t,a,l,o,n,r,i,d,c){function s(e){m.normal.package_id="",dmw.getHotellevel(e),_.emptyval(m.early),_.emptyval(m.delay),$("#tour_plan_h").is(":hidden")||dmw.getTotalPrice()}function p(e,t){var a="/product/_earlydelay.html?product_id="+$productId+"&type="+e+"&date="+t;r.loadShow.init(),$.when($.get(a,function(t){if(r.loadShow.close(),$(".hotelearly_select").html(t),_.popUpScroll("hotelearly_select"),5==e){$("div.hotelearly_select #start_in").val(m.early.start_time);(a=$("div.hotelearly_select [data-id="+m.early.hotel_id+"]")).find("select").eq(0).val(m.early.adult2),a.find("select").eq(1).val(m.early.adult3),a.find("select").eq(2).val(m.early.adult4)}else{$("div.hotelearly_select #start_in").val(m.delay.end_time);var a=$("div.hotelearly_select [data-id="+m.delay.hotel_id+"]");a.find("select").eq(0).val(m.delay.adult2),a.find("select").eq(1).val(m.delay.adult3),a.find("select").eq(2).val(m.delay.adult4)}})).done(function(){var t;t=5==e?m.early:m.delay,$("div.hotelearly_select #start_in").pikaday({defaultDate:5==e?new Date(+new Date(g)-864e5):new Date(+new Date(g)+864e5*parseInt($("span.hotelDelay_time").data("delayday"))),disableDayFn:function(t){var a=parseInt($("span.hotelDelay_time").data("delayday"))-1;if(5==e){if(new Date(t)>new Date(+new Date(g)-864e5))return!0}else if(new Date(t)<new Date(+new Date(g)+864e5*a))return!0},onDisable:function(){r.Walert({closeBtn:!1,contentHtml:5==e?"入住时间只能小于离店时间哦~~":"离店时间只能大于入住时间哦~~"})},onSelect:function(a){$("div.hotelearly_select #start_in").parent().css({border:"1px solid #dadada"}),t.hotel_id="",t.adult2="",t.adult3="",t.adult4="",$("div.hotelearly_select").find("select").val(""),5==e?t.start_time=a:t.end_time=a,dmw.getHotelList(e)}}),$("div.hotelearly_select .confirmHotel").on("click",function(a){a.preventDefault();var l=$(this),o=$("div.hotelearly_select #start_in"),n=l.parents(".item_op"),r=l.parents(".item_op").data("id"),i=l.parents(".item_op").data("name");""!=o.val()?(t.hotel_id=r,n.find("select").each(function(e,a){var l=$(a);switch(l.attr("name")){case"twoadult":t.adult2=l.val();break;case"threeadult":t.adult3=l.val();break;case"foradult":t.adult4=l.val()}}),5==e?m.early.hotel_id&&(m.early.hotel_name=i):m.delay.hotel_id&&(m.delay.hotel_name=i),$("div.hotelearly_select").empty(),dmw.getTotalPrice()):o.parent().css({border:"1px solid #f50"})}),$("div.hotelearly_select .room_list").on("change","select",function(){var e=$("div.hotelearly_select #start_in"),a=$(this),l=a.parents(".item_op"),o=a.parents(".item_op").data("id");""!=e.val()?(t.hotel_id=o,l.find("select").each(function(e,a){var l=$(a);switch(l.attr("name")){case"twoadult":t.adult2=l.val();break;case"threeadult":t.adult3=l.val();break;case"foradult":t.adult4=l.val()}}),dmw.getTotalPrice()):e.parent().css({border:"1px solid #f50"})})})}function u(e){if(f.tableRoomPrice=h[e],f.hasShare=h[e].share_price,!h[e].share_price)for(var t in m.hotel.rooms)m.hotel.rooms[t].share_price=0,$(".change_room input[name='received']").removeAttr("checked");$("#haspriority").attr("data-summember")?(f.maxperson=Number($("#haspriority").attr("data-summember")),f.maxadult=Number($("#haspriority").attr("data-sumadult"))):(f.maxperson=h[e].number,f.maxadult=h[e].number)}var h=[],m=e.$detailDate.tour,f=(maxadult=1,new t({el:"#booking-cart",data:{params:m,normalPackages:[],selectedNormal:"",maxperson:1,maxadult:1,hasShare:1,tableRoomPrice:""},watch:{selectedNormal:function(e){m.normal.package_id=e,dmw.getTotalPrice()}}}));e.$extraFunc.init(m),$("div.hotel-level").hide(),$("#recommend-products").Tabs();var v,_=e.$toolobj;$.when($.get($priceListUrl+"?product_id="+$productId,function(e){e.code?(v=e.data,_.sortedData(v)):v=[]})).done(function(){$(".tipRili").pikaday({position:"bottom right",defaultDate:v.length?new Date(v[0].departing_date):new Date,dayInfo:v,disableDayFn:function(e){if(!_.checkDate(e))return!0},onSelect:function(e){g=e,r.loadShow.init(),$("#start-date").val(e),s(e)}}),$("#start-date").pikaday({dayInfo:v,defaultDate:v.length?new Date(v[0].departing_date):new Date,disableDayFn:function(e){if(!_.checkDate(e))return!0},onDisable:function(){r.Walert({closeBtn:!1,contentHtml:"该日期不可选择"})},onSelect:function(e){g=e,r.loadShow.init(),s(e)}})});var g;$(".toorder").on("click",function(){$("#start-date").trigger("click")}),$(".tipRili").mouseenter(function(){$(this).trigger("click")}),$(".lowpriceinfo").hoverTips({contentHtml:$(".lowpriceinfo").data("info")}),$(".startCity").hoverTips({contentHtml:$(".startCity").text()}),$(".endCity").hoverTips({contentHtml:$(".endCity").text()}),$(".roomstips").hoverTips({contentHtml:$(".roomstips").data("title")}),$(".sharetips").hoverTips({contentHtml:$(".sharetips").data("title")}),$(".smtip").hoverTips({contentHtml:$(".smtip").data("title")}),$("#selroom").on("change",function(e){var t=$(this).val(),a=m.hotel.rooms;a=a.slice(0,1);for(var l=0;l<t-1;l++)a.push({adult:1,child:0,share_price:0});m.hotel.rooms=a,m.adult=0,m.child=0;for(var o=0,n=m.hotel.rooms.length;o<n;o++)m.adult+=m.hotel.rooms[o].adult,m.child+=m.hotel.rooms[o].child;dmw.getTotalPrice()}),$(".change_room").on("change",'select[name="adults"]',function(){var e=$(this),t=parseInt(e.val()),a=e.parent().index();m.hotel.rooms[a].child=0,1!=t&&(m.hotel.rooms[a].share_price=0,e.nextAll("input[name=received]").removeAttr("checked")),m.adult=0,m.child=0,m.hotel.rooms[a].adult=t;for(var l=0,o=m.hotel.rooms.length;l<o;l++)m.adult+=m.hotel.rooms[l].adult,m.child+=m.hotel.rooms[l].child;dmw.getTotalPrice()}),$(".change_room").on("change",'select[name="children"]',function(){var e=$(this),t=parseInt(e.val()),a=e.parent().index();m.hotel.rooms[a].child=t,m.child=0;for(var l=0,o=m.hotel.rooms.length;l<o;l++)m.child+=m.hotel.rooms[l].child;0!=t&&(m.hotel.rooms[a].share_price=0,e.nextAll("input[name=received]").removeAttr("checked")),dmw.getTotalPrice()}),$(".change_room").on("change",'input[name="received"]',function(){var e=$(this),t=e.is(":checked"),a=e.parent().index();m.hotel.rooms[a].share_price=!0===t?1:0,dmw.getTotalPrice()}),$("input[name='need_ad']").on("change",function(){$(this);$(".advance_delay").toggle("slow",function(){$(".advance_delay").is(":hidden")&&(m.early.hotel_name||m.early.hotel_name)&&(_.emptyval(m.early),_.emptyval(m.delay),dmw.getTotalPrice())})});var y,k;$("input.addr_selbox").on("click",function(e){e.preventDefault();var t=$(this).data("id");y=t;var a="/product/_addr.html?product_id="+$productId+"&type="+t;r.loadShow.init(),$.get(a,function(e){r.loadShow.close(),$(".tour_planaddr").html(e),_.popUpScroll("tour_planaddr"),$(".tour_planaddr input").each(function(e,t){switch(y){case 1:$(t).val()==m.addrs.pick_up.id&&$(t).attr("checked",!0);break;case 2:$(t).val()==m.addrs.gather_place.id&&$(t).attr("checked",!0);break;case 3:$(t).val()==m.addrs.group_place.id&&$(t).attr("checked",!0);break;case 4:$(t).val()==m.addrs.see_off.id&&$(t).attr("checked",!0)}})})}),$(".tour_planaddr").on("change","input[name=addr]",function(e){e.preventDefault();var t=$(this);if(t.is(":checked"))switch($(".addr_selbox"+y).val(t.data("address")),$(".addr_selbox"+y).data("addrid",t.val()),y){case 1:m.addrs.pick_up.id=t.val(),m.addrs.pick_up.addr=t.data("address");break;case 2:m.addrs.gather_place.id=t.val(),m.addrs.gather_place.addr=t.data("address");break;case 3:m.addrs.group_place.id=t.val(),m.addrs.group_place.addr=t.data("address");break;case 4:m.addrs.see_off.id=t.val(),m.addrs.see_off.addr=t.data("address")}}),$("input.optional_selbox").on("click",function(e){e.preventDefault();var t=$(this).data("id");y=t;var a="/product/_optional.html?product_id="+$productId;r.loadShow.init(),$.get(a,function(e){r.loadShow.close(),$(".tour_selfplan").html(e),_.popUpScroll("tour_selfplan");var t=$(".tour_selfplan").find("table").length,a=m.optional.packages;if(a.length<t){a=a.slice(0,1);for(o=0;o<t;o++)a.push({package_id:"",packageitem_id:"",addr:""});a.pop(),m.optional.packages=a}for(var l="",o=0,t=m.optional.packages.length;o<t;o++)l+=m.optional.packages[o].packageitem_id+",";$(".tour_selfplan input").each(function(e,t){-1!=$.inArray(String($(t).data("id")),l.split(","))&&$(t).attr("checked",!0)})})}),$(".tour_selfplan").on("change","input[name=selfsel]",function(e){e.preventDefault();var t=$(this),a=0,l=t.parents("table").data("minnumber"),o=t.parents("table").data("maxnumber"),n=t.parents("table").data("title");t.parents("table").find("input").each(function(e,t){$(t).is(":checked")&&a++}),a>o&&r.Walert({closeBtn:!1,contentHtml:n+"最多选"+o+"个最少选"+l+"个"})}),$(".tour_selfplan").on("click",".self_okbtn",function(e){e.preventDefault();var t=0,a="",l=$(".tour_selfplan").find("table"),o=m.optional.packages;l.each(function(e,l){var n=$(l),i=0,d=n.data("title"),c=n.data("minnumber"),s=n.data("maxnumber"),p=n.find("input");if(o[e].packageitem_id="",o[e].addr="",o[e].package_id=c>0||n.find("input:checked").length>0?n.data("id"):"",p.each(function(t,l){$(l).is(":checked")&&(i++,a+=""==a?$(l).data("addrname"):","+$(l).data("addrname"),""==o[e].addr?(o[e].packageitem_id=$(l).data("id"),o[e].addr=$(l).data("addrname")):(o[e].packageitem_id+=","+$(l).data("id"),o[e].addr+=","+$(l).data("addrname")))}),i>s||i<c)return r.Walert({closeBtn:!1,contentHtml:d+"最多选"+s+"个最少选"+c+"个"}),t=0,!1;t=1}),t&&($("input.optional_selbox").val(a),$(".tour_selfplan").empty(),dmw.getTotalPrice())}),$(function(){var e=$("input.tour_selbox").length,t=m.traveling.viewspots;if(t.length<e){t=t.slice(0,1);for(var a=0;a<e;a++)t.push({viewspot:"",package_id:"",addr:""});t.pop(),m.traveling.viewspots=t}}),$("input.tour_selbox").on("click",function(e){e.preventDefault();var t=$(this),a=t.data("id"),l=t.data("spotid");k=l;var o="/product/_trip.html?product_id="+$productId+"&trip_id="+a;r.loadShow.init(),$.when($.get(o,function(e){r.loadShow.close(),$(".tour_selfsel").html(e),_.popUpScroll("tour_selfsel")})).done(function(){var e=m.traveling.viewspots[k].viewspot.split(",");$(".tour_selfsel input").each(function(t,a){-1!=$.inArray(String($(a).data("id")),e)&&$(a).attr("checked",!0)})})}),$(".tour_selfsel").on("click",".tour_okbtn",function(e){e.preventDefault();var t="",a=$(".tour_selfsel input"),l=$("input.tour_selbox[data-spotid="+k+"]"),o=0,n=a.parents("table").data("minnumber"),i=a.parents("table").data("maxnumber");if(a.each(function(e,a){$(a).is(":checked")&&(o++,""==t?t=$(a).data("addrname"):t+=","+$(a).data("addrname"))}),o>i||o<n)return r.Walert({closeBtn:!1,contentHtml:"最多选"+i+"个最少选"+n+"个"}),!1;""==!m.traveling.viewspots[k].viewspot?m.traveling.viewspots[k].package_id=l.data("id"):m.traveling.viewspots[k].package_id="",dmw.getTotalPrice(),$(".tour_selfsel").empty()});var w=m.traveling.viewspots;$(".tour_selfsel").on("change","input",function(e){e.preventDefault();var t=$(this),a=0,l=t.parents("table").data("maxnumber");if(t.parents("table").find("input").each(function(e,t){$(t).is(":checked")&&a++}),a>l)return t.removeAttr("checked"),void r.Walert({closeBtn:!1,contentHtml:"最多选"+l+"个"});t.is(":checked")?""==w[k].viewspot?(w[k].viewspot=""+t.data("id"),w[k].addr=""+t.data("addrname")):(w[k].viewspot+=","+t.data("id"),w[k].addr+=","+t.data("addrname")):(w[k].viewspot=_.delObjval(w[k].viewspot,t.data("id")),w[k].addr=_.delObjval(w[k].addr,t.data("addrname")))});var b;$("input.advance_input").on("focus",function(e){b=5,m.early.end_time=m.departing_date,p(5,m.departing_date)}),$("input.delay_input").on("focus",function(e){b=6;var t=parseInt($("span.hotelDelay_time").data("delayday"))-1,a=new Date(+new Date(g)+864e5*t),l=a.getFullYear()+"-"+(a.getMonth()+1<10?"0"+(a.getMonth()+1):a.getMonth()+1)+"-"+(a.getDate()<10?"0"+a.getDate():a.getDate());m.delay.start_time=l,p(6,l)}),$(".tour_planaddr").on("click",".addr_okbtn",function(e){e.preventDefault(),$(".tour_planaddr").empty()}),$(".tour_planaddr").on("click",".addrsel_close",function(e){switch(e.preventDefault(),$(".tour_planaddr").empty(),y){case 1:_.emptyval(m.addrs.pick_up);break;case 2:_.emptyval(m.addrs.gather_place);break;case 3:_.emptyval(m.addrs.group_place);break;case 4:_.emptyval(m.addrs.see_off)}}),$(".tour_selfplan").on("click",".mandaself_close",function(e){e.preventDefault(),$(".tour_selfplan").empty()}),$(".tour_selfsel").on("click",".toursel_close",function(e){e.preventDefault(),$(".tour_selfsel").empty(),_.emptyval(m.traveling.viewspots[k]),dmw.getTotalPrice()}),$(".hotelearly_select").on("click",".hotel_sel_close",function(e){e.preventDefault(),5==b?_.emptyval(m.early):_.emptyval(m.delay),$(".hotelearly_select").empty(),dmw.getTotalPrice()}),$("div.hotel-level").on("change","select",function(){var e=$(this),t=e.prop("selectedIndex");m.hotel.package_id=e.val(),u(t),$("#tour_plan_h").slideDown("slow",function(){nav_scroll.update(),days_Scroll.update()}),dmw.getTotalPrice()}),dmw.getHotellevel=function(e){m.departing_date=e,$.ajax({type:"POST",url:$tourpriceUrl+"?action=getPackageList",data:m,dataType:"json",success:function(e){r.loadShow.close();var t="",a=e.data.hotel.packages;f.normalPackages=e.data.normal?e.data.normal.packages:"",f.selectedNormal="",h=a;for(var l=0,o=a.length;l<o;l++)t+="<option value="+a[l].package_id+">"+a[l].name+"</option>";m.hotel.package_id=a[0].package_id,u(0),$(".hotel-level").show(),$(".ht_level_sel option").remove(),$(".ht_level_sel").append(t),$(".ht_level_sel").get(0).selectedIndex=0,$("#tour_plan_h").is(":hidden")&&$(".ht_level_sel").trigger("change")},error:function(e){r.loadShow.close(),r.Walert({closeBtn:!1,contentHtml:"请求失败"})}})},dmw.getHotelList=function(e){var t=$.extend(!0,{},m);_.deleteKey(t),$.ajax({type:"POST",url:$tourpriceUrl+"?action="+(5==e?"getEarlyHoteList":"getDelayHoteList"),data:t,dataType:"json",success:function(e){if(1==e.code){var t=e.data.hotels,a=$(".hotelearly_select .item_op");if(a.length)if(t&&t.length){a.hide();for(var l=0,o=t.length;l<o;l++){var n=$("div.item_op[data-id="+t[l].hotel_id+"]");n.show();var i=n.find("li");switch(i.show(),t[l].number){case 2:i.eq(1).hide(),i.eq(2).hide();break;case 3:i.eq(2).hide()}}}else r.Walert({closeBtn:!1,contentHtml:e.info})}else $(".hotelearly_select .item_op").hide(),r.Walert({closeBtn:!1,contentHtml:e.info})},error:function(e){r.Walert({closeBtn:!1,contentHtml:e.info})}})};var x=!0;dmw.getTotalPrice=function(){var e=$.extend(!0,{},m);_.deleteKey(e),$.ajax({type:"POST",url:$tourpriceUrl+"?action=getTotalPrice",data:e,dataType:"json",success:function(e){if(e.code){x=!0;var t=e.data.price,a=parseInt(m.adult)+parseInt(m.child),l=e.data.additional;if(l&&l.list)for(var o in l.list)$(".formPrice"+o).val(l.list[o].price),$(".additional"+o).children(".other_pr_price").text(l.list[o].price),$("div.combo-info form[data-id="+o+"]").attr("data-price",l.list[o].price),$("div.combo-info form[data-id="+o+"]").find("input[type=checkbox]").is(":checked")||(t-=l.list[o].price);m.price=t.toFixed(2),m.cost=e.data.cost,m.save=(t/a).toFixed(2),(e.data.early||e.data.delay)&&$("span.hotelRoom_price em").text(5==b?e.data.early.price:e.data.delay.price)}else x=!1,r.Walert({closeBtn:!1,contentHtml:e.info})},error:function(e){r.Walert({closeBtn:!1,contentHtml:"网络请求失败"})}})},$(".book-start").on("click",function(e){e.preventDefault();var t=$(".start-date").val(),a=$("select[name='ht_level']").val(),o=$("input.optional_selbox").val(),n=$("input.addr_selbox"),i=$("input.tour_selbox"),d=1;if(""==t)return r.Walert({closeBtn:!1,contentHtml:"请先选择出发日期"}),!1;if(0==a)return r.Walert({closeBtn:!1,contentHtml:"请先选择酒店级别"}),!1;if(0==o)return r.Walert({closeBtn:!1,contentHtml:"请先选择必选套餐"}),!1;if(n.each(function(e,t){if(""==$(t).val())return d=0,r.Walert({closeBtn:!1,contentHtml:"请先选择"+$(t).prev("label").text()}),!1}),d&&i.each(function(e,t){if(0!=$(t).data("need")&&""==$(t).val())return d=0,r.Walert({closeBtn:!1,contentHtml:"请先选择"+$(t).prev("label").text()}),!1}),x){if(d&&x){$("div.combo-info form").each(function(e,t){$(t).find("input[type=checkbox]").is(":checked")||_.emptyObject(m.additional[$(t).attr("data-id")])});var c=$.extend(!0,{},m);_.deleteKey(c),$.post(cartUrl,c,function(e){1==e.code?l.dmPublogin.init():4==e.code?($(".book-start").shoping(),$("#cart-num").text($.cookie("cart_number")),r.Galert({needIcon:!0,contentHtml:[e.info],diyBtns:["前往结算","我再逛逛"],diyUrl:["/my/cart.html","javascript:;"],tailContent:[""],closeBtn:!0,close:function(){$(".dm-g-fixedmask").hide().remove()}})):r.Walert({closeBtn:!1,contentHtml:e.info})})}}else r.Walert({closeBtn:!1,contentHtml:"产品价格错误~~"})})})});